/*
Advanced Malware Detection Rules for USB Security Scanner
Version: 2.0 Enterprise
Description: Comprehensive detection rules for various malware families
*/

// ==================== RANSOMWARE DETECTION ====================
rule Ransomware_Generic {
    meta:
        description = "Detects generic ransomware patterns"
        severity = "CRITICAL"
        author = "USB Security Scanner Team"
        date = "2024"
    
    strings:
        $ransom_note1 = "Your files are encrypted" nocase
        $ransom_note2 = "Pay the ransom" nocase
        $ransom_note3 = "Your files have been encrypted" nocase
        $ransom_note4 = "Decrypt your files" nocase
        $ransom_note5 = "Bitcoin" nocase
        $ransom_note6 = "RECOVERY_KEY" nocase
        $ransom_note7 = "LOCKED" nocase
        $crypto_ext1 = ".locked"
        $crypto_ext2 = ".encrypted"
        $crypto_ext3 = ".crypted"
        $tor_domain = ".onion" nocase
        
    condition:
        any of ($ransom_note*) or 
        (any of ($crypto_ext*) and $tor_domain) or
        (3 of ($ransom_note*))
}

rule Ransomware_WannaCry {
    meta:
        description = "WannaCry ransomware detection"
        severity = "CRITICAL"
        reference = "https://www.microsoft.com/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/WannaCrypt"
    
    strings:
        $wc1 = "WannaCry" wide
        $wc2 = "WannaDecryptor" wide
        $wc3 = "WNcry@2ol7" wide
        $wc4 = "tasksche.exe" wide
        $wc5 = "msg\\*.wmf" wide
        
    condition:
        2 of them
}

rule Ransomware_Locky {
    meta:
        description = "Locky ransomware detection"
        severity = "HIGH"
    
    strings:
        $locky1 = "Locky" wide
        $locky2 = "_Locky_recover_instructions" wide
        $locky3 = "www.anywhere.life" wide
        $locky4 = "\\_Locky_recover_instructions.txt" wide
        
    condition:
        2 of them
}

// ==================== TROJAN & BACKDOOR DETECTION ====================
rule Trojan_Generic {
    meta:
        description = "Generic trojan horse detection"
        severity = "HIGH"
    
    strings:
        $trojan1 = "backdoor" nocase
        $trojan2 = "remote access" nocase
        $trojan3 = "keylogger" nocase
        $trojan4 = "rat" nocase
        $trojan5 = "trojan" nocase
        $trojan6 = "spyware" nocase
        $trojan7 = "stealer" nocase
        $trojan8 = "information stealer" nocase
        
    condition:
        3 of them
}

rule Backdoor_Meterpreter {
    meta:
        description = "Metasploit Meterpreter backdoor detection"
        severity = "CRITICAL"
    
    strings:
        $m1 = "meterpreter" nocase
        $m2 = "metsrv.dll" wide
        $m3 = "Reflective DLL Injection" wide
        $m4 = "stdapi" wide
        
    condition:
        2 of them
}

rule Trojan_Nanocore {
    meta:
        description = "Nanocore RAT detection"
        severity = "HIGH"
    
    strings:
        $nc1 = "NanoCore" wide
        $nc2 = "NanoCore.Client" wide
        $nc3 = "PluginManager" wide
        $nc4 = "ServerMutex" wide
        
    condition:
        2 of them
}

// ==================== INFOSTEALERS ====================
rule Infostealer_Generic {
    meta:
        description = "Generic information stealer detection"
        severity = "HIGH"
    
    strings:
        $stealer1 = "password" nocase
        $stealer2 = "credential" nocase
        $stealer3 = "cookie" nocase
        $stealer4 = "autofill" nocase
        $stealer5 = "credit card" nocase
        $stealer6 = "wallet.dat" wide
        $stealer7 = "login data" nocase
        $stealer8 = "User Data" wide
        
    condition:
        (4 of ($stealer*)) and filesize < 10MB
}

rule Infostealer_RedLine {
    meta:
        description = "RedLine Stealer detection"
        severity = "HIGH"
    
    strings:
        $rl1 = "RedLine" wide
        $rl2 = "SystemInformationGather" wide
        $rl3 = "StealerModule" wide
        $rl4 = "GrabberModule" wide
        $rl5 = "\\logs\\" wide
        
    condition:
        3 of them
}

// ==================== CRYPTO MINERS ====================
rule Miner_Generic {
    meta:
        description = "Cryptocurrency miner detection"
        severity = "MEDIUM"
    
    strings:
        $miner1 = "stratum+tcp" wide
        $miner2 = "xmrig" wide
        $miner3 = "ccminer" wide
        $miner4 = "cryptonight" wide
        $miner5 = "mining pool" nocase
        $miner6 = "cpu usage" nocase
        $miner7 = "gpu mining" nocase
        $miner8 = "hashrate" nocase
        
    condition:
        3 of them
}

rule Miner_XMRig {
    meta:
        description = "XMRig Monero miner detection"
        severity = "MEDIUM"
    
    strings:
        $xmr1 = "xmrig.exe" wide
        $xmr2 = "config.json" wide
        $xmr3 = "donate-level" wide
        $xmr4 = "nicehash" wide
        $xmr5 = "monero" wide
        
    condition:
        2 of them
}

// ==================== WORMS & VIRUSES ====================
rule Worm_Autorun {
    meta:
        description = "Autorun.inf based worm detection"
        severity = "HIGH"
    
    strings:
        $a1 = "[AutoRun]" wide
        $a2 = "open=" wide
        $a3 = "shellexecute=" wide
        $a4 = "action=" wide
        $a5 = "AutoRun.inf" wide
        
    condition:
        $a1 and ($a2 or $a3)
}

rule Virus_VBS {
    meta:
        description = "VBScript virus detection"
        severity = "HIGH"
    
    strings:
        $vbs1 = "CreateObject(\"WScript.Shell\")" nocase
        $vbs2 = ".Run" nocase
        $vbs3 = "Scripting.FileSystemObject" nocase
        $vbs4 = ".CopyFile" nocase
        $vbs5 = ".DeleteFile" nocase
        $vbs6 = "On Error Resume Next" nocase
        
    condition:
        3 of them and filesize < 100KB
}

// ==================== EXPLOIT KITS & SHELLCODE ====================
rule Exploit_Shellcode {
    meta:
        description = "Generic shellcode detection"
        severity = "HIGH"
    
    strings:
        // Common shellcode patterns
        $sc1 = { 33 C0 50 68 2E 65 78 65 68 63 61 6C 63 }  // calc.exe shellcode
        $sc2 = { FC 33 D2 B2 30 64 FF 32 5A 8B }          // Windows shellcode
        $sc3 = { E8 00 00 00 00 5B 83 EB 05 }            // Position independent code
        
    condition:
        any of them
}

rule Exploit_PDF {
    meta:
        description = "PDF exploit patterns"
        severity = "HIGH"
    
    strings:
        $pdf1 = "/JavaScript" wide
        $pdf2 = "/JS" wide
        $pdf3 = "/AA" wide
        $pdf4 = "/OpenAction" wide
        $pdf5 = "/Launch" wide
        $pdf6 = "/EmbeddedFile" wide
        
    condition:
        ($pdf1 or $pdf2) and ($pdf3 or $pdf4 or $pdf5)
}

// ==================== OFFICE MACRO MALWARE ====================
rule Office_Macro_Malware {
    meta:
        description = "Malicious Office macro detection"
        severity = "HIGH"
    
    strings:
        $macro1 = "AutoOpen" nocase
        $macro2 = "Document_Open" nocase
        $macro3 = "Workbook_Open" nocase
        $macro4 = "Shell(" nocase
        $macro5 = "WScript.Shell" nocase
        $macro6 = "CreateObject" nocase
        $macro7 = "PowerShell" nocase
        $macro8 = "cmd.exe" nocase
        
    condition:
        (any of ($macro1, $macro2, $macro3)) and (any of ($macro4, $macro5, $macro6, $macro7, $macro8))
}

// ==================== POWERSHELL-BASED MALWARE ====================
rule PowerShell_Malicious {
    meta:
        description = "Malicious PowerShell scripts"
        severity = "HIGH"
    
    strings:
        $ps1 = "-EncodedCommand" nocase
        $ps2 = "FromBase64String" nocase
        $ps3 = "IEX" nocase
        $ps4 = "Invoke-Expression" nocase
        $ps5 = "DownloadString" nocase
        $ps6 = "WebClient" nocase
        $ps7 = "Start-Process" nocase
        $ps8 = "Hidden" nocase
        $ps9 = "Bypass" nocase
        $ps10 = "Unrestricted" nocase
        
    condition:
        ($ps1 and $ps2) or (3 of ($ps3, $ps4, $ps5, $ps6, $ps7, $ps8, $ps9, $ps10))
}

rule PowerShell_Reverse_Shell {
    meta:
        description = "PowerShell reverse shell"
        severity = "CRITICAL"
    
    strings:
        $rev1 = "System.Net.Sockets.TCPClient" nocase
        $rev2 = "StreamWriter" nocase
        $rev3 = "StreamReader" nocase
        $rev4 = "ProcessStartInfo" nocase
        $rev5 = "CreateNoWindow" nocase
        
    condition:
        3 of them
}

// ==================== OBFUSCATION & PACKING ====================
rule Packed_Executable {
    meta:
        description = "Packed or obfuscated executable"
        severity = "MEDIUM"
    
    strings:
        $packer1 = "UPX" wide
        $packer2 = "ASPack" wide
        $packer3 = "PECompact" wide
        $packer4 = "Themida" wide
        $packer5 = "VMProtect" wide
        $packer6 = "Armadillo" wide
        
    condition:
        any of them
}

rule Obfuscated_Code {
    meta:
        description = "Obfuscated code patterns"
        severity = "MEDIUM"
    
    strings:
        $ob1 = "eval(" nocase
        $ob2 = "unescape(" nocase
        $ob3 = "fromCharCode" nocase
        $ob4 = "base64_decode" nocase
        $ob5 = "rot13" nocase
        $ob6 = "deobfuscate" nocase
        
    condition:
        3 of them
}

// ==================== SUSPICIOUS NETWORK ACTIVITY ====================
rule Suspicious_Domains {
    meta:
        description = "Suspicious domain patterns"
        severity = "MEDIUM"
    
    strings:
        $domain1 = "dynamic-dns" nocase
        $domain2 = "no-ip" nocase
        $domain3 = "duckdns" nocase
        $domain4 = ".ddns.net" nocase
        $domain5 = ".servehttp.com" nocase
        $domain6 = ".myftp.org" nocase
        
    condition:
        any of them
}

rule C2_Communication {
    meta:
        description = "Command and control communication patterns"
        severity = "HIGH"
    
    strings:
        $c2_1 = "checkin" nocase
        $c2_2 = "heartbeat" nocase
        $c2_3 = "beacon" nocase
        $c2_4 = "command" nocase
        $c2_5 = "task" nocase
        $c2_6 = "result" nocase
        
    condition:
        3 of them
}

// ==================== ANTI-ANALYSIS & EVASION ====================
rule Anti_VM {
    meta:
        description = "Virtual machine detection techniques"
        severity = "MEDIUM"
    
    strings:
        $vm1 = "VirtualBox" wide
        $vm2 = "VMware" wide
        $vm3 = "VBox" wide
        $vm4 = "Xen" wide
        $vm5 = "QEMU" wide
        $vm6 = "sandbox" nocase
        $vm7 = "WINE" wide
        
    condition:
        2 of them
}

rule Anti_Debug {
    meta:
        description = "Anti-debugging techniques"
        severity = "MEDIUM"
    
    strings:
        $dbg1 = "IsDebuggerPresent" wide
        $dbg2 = "CheckRemoteDebuggerPresent" wide
        $dbg3 = "OutputDebugString" wide
        $dbg4 = "GetTickCount" wide
        $dbg5 = "QueryPerformanceCounter" wide
        
    condition:
        3 of them
}

// ==================== FILELESS MALWARE INDICATORS ====================
rule Fileless_Techniques {
    meta:
        description = "Fileless malware techniques"
        severity = "HIGH"
    
    strings:
        $fl1 = "regsvr32" nocase
        $fl2 = "scrobj.dll" nocase
        $fl3 = "mshta" nocase
        $fl4 = "javascript:" nocase
        $fl5 = "vbscript:" nocase
        $fl6 = "rundll32" nocase
        $fl7 = "certutil" nocase
        $fl8 = "wmic" nocase
        
    condition:
        3 of them
}

// ==================== SUSPICIOUS SCRIPT PATTERNS ====================
rule JavaScript_Malicious {
    meta:
        description = "Malicious JavaScript patterns"
        severity = "HIGH"
    
    strings:
        $js1 = "ActiveXObject" nocase
        $js2 = "WScript.Shell" nocase
        $js3 = "Scripting.FileSystemObject" nocase
        $js4 = "eval(" nocase
        $js5 = "document.write(" nocase
        $js6 = "unescape(" nocase
        $js7 = "fromCharCode" nocase
        
    condition:
        3 of them
}

rule Batch_File_Malicious {
    meta:
        description = "Malicious batch file patterns"
        severity = "HIGH"
    
    strings:
        $bat1 = "format " nocase
        $bat2 = "del " nocase
        $bat3 = "rmdir " nocase
        $bat4 = "attrib " nocase
        $bat5 = "reg delete" nocase
        $bat6 = "shutdown" nocase
        $bat7 = "taskkill" nocase
        $bat8 = "vssadmin" nocase
        
    condition:
        4 of them and filesize < 10KB
}

// ==================== ADVANCED HEURISTICS ====================
rule High_Entropy_Region {
    meta:
        description = "High entropy regions (possible encryption/packing)"
        severity = "LOW"
    
    condition:
        // This requires entropy calculation which YARA doesn't do natively
        // Placeholder for integration with scanner's entropy detection
        false
}

rule Suspicious_Combination {
    meta:
        description = "Suspicious combination of techniques"
        severity = "MEDIUM"
    
    strings:
        $combo1 = "CreateRemoteThread" wide
        $combo2 = "VirtualAllocEx" wide
        $combo3 = "WriteProcessMemory" wide
        $combo4 = "LoadLibrary" wide
        
    condition:
        all of them
}

// ==================== INDICATORS OF COMPROMISE (IoCs) ====================
rule Known_Malware_Hashes {
    meta:
        description = "Known malicious file hashes"
        severity = "CRITICAL"
    
    strings:
        // These would be populated with known malicious hashes
        // Example placeholder - in practice, this would be a large list
        $hash1 = "e4d909c290d0fb1ca068ffaddf22cbd0" // Example MD5
        $hash2 = "7d158aefe7f479c8f1be0d90a8b87b45" // Example MD5
        
    condition:
        any of them
}

// ==================== EMERGING THREATS ====================
rule Supply_Chain_Attack {
    meta:
        description = "Supply chain attack indicators"
        severity = "HIGH"
    
    strings:
        $sc1 = "node_modules" wide
        $sc2 = "package.json" wide
        $sc3 = "postinstall" nocase
        $sc4 = "preinstall" nocase
        $sc5 = "dependencies" nocase
        
    condition:
        ($sc1 or $sc2) and ($sc3 or $sc4)
}

rule COVID_19_Themed {
    meta:
        description = "COVID-19 themed malware"
        severity = "MEDIUM"
    
    strings:
        $covid1 = "coronavirus" nocase
        $covid2 = "covid" nocase
        $covid3 = "vaccine" nocase
        $covid4 = "pandemic" nocase
        $covid5 = "lockdown" nocase
        
    condition:
        2 of them and filesize < 5MB
}

/*
USAGE INSTRUCTIONS:
1. Save this file as "malware_rules.yar"
2. Use with USB Security Scanner: python usb_scanner_enterprise.py --yara-file malware_rules.yar
3. Regularly update the rules with new threat intelligence

NOTE: Some rules (like entropy-based detection) require integration with the scanner's
built-in capabilities and won't work with YARA alone.
*/